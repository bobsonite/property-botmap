<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Housing ‚Äî Bot + Map</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body { margin:0; height:100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { display:flex; height:100vh; }
    #botPane { width: 28vw; min-width: 320px; overflow:auto; }
    #map { flex: 1; }
    .topbar { position:absolute; right:12px; top:12px; background:#fff; padding:8px 10px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.08); z-index:2; font-size:12px;}
    .pill { display:inline-block; background:#f2f2f2; padding:2px 8px; border-radius:999px; margin-left:6px; }
    .pin { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; background:#fff; box-shadow:0 1px 6px rgba(0,0,0,.18); border:1px solid #ddd; }
    .pin--prop { border-color:#2563eb; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="botPane" title="Student Bot"></div>
    <div id="map"></div>
    <div class="topbar">session_id: <span id="sid" class="pill"></span></div>
  </div>

  <!-- Libs -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module" src="https://cdn.landbot.io/landbot-3/landbot-3.0.0.mjs"></script>

  <script type="module">
    /************ CONFIG ************/
    const MAPBOX_TOKEN      = 'pk.eyJ1IjoiYm9ic29uaXRlIiwiYSI6ImNtOXpyeWc1aDFlY24ya3M3dm55a2oyNDcifQ.8H2wkga07prlTm_YpOQicA';
    // Your Ably key (kept for future, not required for props flow)
    const ABLY_CLIENT_KEY   = 'Pc6iLw.uon00w:xfKlxamIh-D0uHTtyW5l_VOzDdk2BEFjyeHsGYcC4N0';
    // Your colleague's Ably key (n8n publishes here ‚Üí channel "props")
    const PEER_ABLY_KEY     = '9hDZwQ.LMHMDw:rHPAP8YjEeVfa5-SYle5UBnVtGpIFpck8fO4YH42Gp0';

    const SUPABASE_URL      = 'https://fobibwavppcxfqpshrfp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvYmlid2F2cHBjeGZxcHNocmZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MDM2NTMsImV4cCI6MjA2OTE3OTY1M30.8QhebFQ8i0A5nUmz_g4cQ0ncbTgncsT6ZWNlRGZyLSM';

    // Landbot config (same as your colleague‚Äôs)
    const LANDBOT_CONFIG_URL = 'https://storage.googleapis.com/landbot.pro/v3/H-3134109-L1UF7O5PAQOKJEPB/index.json';
    /********************************/

    // --- Session id (for display + Landbot variable) ---
    const newId = () => (crypto?.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
    const urlParams = new URLSearchParams(location.search);
    const sessionId = urlParams.get('session_id') || newId();
    document.getElementById('sid').textContent = sessionId;

    // --- Landbot embed in left panel ---
    new window.Landbot.Container({
      container: '#botPane',
      configUrl: LANDBOT_CONFIG_URL,
      variables: { session_id: sessionId }
    });

    // --- Map ---
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [-0.1276, 51.5072],
      zoom: 9
    });

    // --- Supabase ---
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Ably: keep your app (future use), plus peer app for "props" ---
    const ably      = new Ably.Realtime({ key: ABLY_CLIENT_KEY, clientId: sessionId }); // not used right now
    const peerAbly  = new Ably.Realtime(PEER_ABLY_KEY); // THIS is where the bot publishes
    const propsChan = peerAbly.channels.get('props');

    // ---------------- Marker helpers ----------------
    const markersById = new Map();

    function makeMarkerEl() {
      const el = document.createElement('div');
      el.className = 'pin pin--prop';
      el.textContent = 'üè†';
      return el;
    }

    function addOrMoveMarker(row) {
      const id = row.propID || row.id;
      const marker = markersById.get(id) ?? new mapboxgl.Marker({ element: makeMarkerEl(), anchor:'bottom' });
      marker
        .setLngLat([row.lon, row.lat])
        .setPopup(new mapboxgl.Popup({ offset: 8 }).setHTML(`
          <div style="font-size:13px; line-height:1.35">
            <div style="font-weight:600">${row.property || ''}</div>
            <div style="color:#666">${row.city || ''}</div>
            ${row.link ? `<div style="margin-top:6px"><a href="${row.link}" target="_blank" rel="noopener">Open page ‚Üí</a></div>` : ''}
          </div>
        `))
        .addTo(map);
      markersById.set(id, marker);
    }

    function clearMarkers(){ for (const m of markersById.values()) m.remove(); markersById.clear(); }
    function fitToMarkers(pad=60){
      const coords = [...markersById.values()].map(m => m.getLngLat());
      if (!coords.length) return;
      if (coords.length===1){ map.flyTo({ center: coords[0], zoom: 14, duration: 600 }); return; }
      const b = new mapboxgl.LngLatBounds(coords[0], coords[0]); coords.forEach(c => b.extend(c));
      map.fitBounds(b, { padding: pad, duration: 700 });
    }

    // ---------------- Geocoding (cache) ----------------
    const _geoCache = new Map();
    async function geocodeAddress(q){
      if (!q) return null;
      const key = q.trim().toLowerCase();
      if (_geoCache.has(key)) return _geoCache.get(key);
      const url = new URL(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json`);
      url.searchParams.set('access_token', MAPBOX_TOKEN);
      url.searchParams.set('limit','1');
      try {
        const r = await fetch(url); const j = await r.json();
        const f = j.features?.[0];
        if (f?.center?.length===2){
          const val = { lon:f.center[0], lat:f.center[1] };
          _geoCache.set(key, val);
          return val;
        }
      } catch(e){ console.error('geocode failed', e); }
      return null;
    }

    // ---------------- Fetch properties by IDs (from test_prop) ----------------
    async function fetchPropsByIds(propIDs){
      if (!Array.isArray(propIDs) || !propIDs.length) return [];
      const { data, error } = await supabase
        .from('test_prop')
        .select('propID, property, city, adress, Long, Lat, link')
        .in('propID', propIDs.map(String));
      if (error) { console.error('[supabase] test_prop fetch error', error); return []; }

      const out = [];
      for (const r of data){
        const lat = r.Lat ?? null;
        const lon = r.Long ?? null;

        let g = null;
        if (lat == null || lon == null){
          const q = r.adress || `${r.property||''}, ${r.city||''}, UK`;
          g = await geocodeAddress(q);
        }
        const finalLat = lat ?? g?.lat;
        const finalLon = lon ?? g?.lon;
        if (finalLat == null || finalLon == null) continue;

        out.push({
          id: r.propID,
          propID: r.propID,
          property: r.property,
          city: r.city,
          lat: finalLat,
          lon: finalLon,
          link: r.link || null,
          _kind: 'prop'
        });
      }
      return out;
    }

    // ---------------- Listen to your colleague's "props" messages ----------------
    propsChan.subscribe(async (msg) => {
      const raw = msg?.data?.propIDs;
      // Accept array OR comma-separated string
      const ids = Array.isArray(raw)
        ? raw.map(v => String(v).trim()).filter(Boolean)
        : String(raw ?? '')
            .split(',')
            .map(s => s.trim())
            .filter(Boolean);

      if (!ids.length) return;

      clearMarkers();
      const rows = await fetchPropsByIds(ids);
      rows.forEach(addOrMoveMarker);
      fitToMarkers();
    });

    // (Optional) expose a tiny helper for manual testing in console
    window._show = async (...ids) => {
      clearMarkers();
      const rows = await fetchPropsByIds(ids.flat());
      rows.forEach(addOrMoveMarker);
      fitToMarkers();
    };
  </script>
</body>
</html>