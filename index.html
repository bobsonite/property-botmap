<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Housing — Bot + Map</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body { margin:0; height:100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { display:flex; height:100vh; }
    #botPane { width: 28vw; min-width: 320px; border: 0; }
    #map { flex: 1; }
    .topbar { position:absolute; right:12px; top:12px; background:#fff; padding:8px 10px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.08); z-index:2; font-size:12px;}
    .pill { display:inline-block; background:#f2f2f2; padding:2px 8px; border-radius:999px; margin-left:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 1) Left: bot iframe (we'll set src in JS so we can append ?session_id=...) -->
    <iframe id="botPane" title="Student Bot"></iframe>

    <!-- 2) Right: Map -->
    <div id="map"></div>

    <!-- Simple HUD -->
    <div class="topbar">
      session_id: <span id="sid" class="pill"></span>
    </div>
  </div>

  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <!-- Ably Realtime JS (browser) -->
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>

  <script>
    /************ FILL THESE IN ************/
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiYm9ic29uaXRlIiwiYSI6ImNtOXpyeWc1aDFlY24ya3M3dm55a2oyNDcifQ.8H2wkga07prlTm_YpOQicA'; // your token
    const ABLY_CLIENT_KEY = 'Pc6iLw.uon00w:xfKlxamIh-D0uHTtyW5l_VOzDdk2BEFjyeHsGYcC4N0'; // create a read/subscribe key in Ably → API Keys
    const BOT_URL = 'https://YOUR-BOT-DOMAIN/chat'; // your colleague’s public bot URL
    /****************************************/

    // 0) Create or read session_id (so each tab has its own channel)
    function newId() {
      return (crypto && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).slice(2);
    }
    const urlParams = new URLSearchParams(location.search);
    const sessionId = urlParams.get('session_id') || newId();

    // Show it in the HUD
    document.getElementById('sid').textContent = sessionId;

    // 1) Put the bot on the page, passing session_id in the iframe URL
    const botSrc = new URL(BOT_URL);
    botSrc.searchParams.set('session_id', sessionId);
    document.getElementById('botPane').src = botSrc.toString();

    // 2) Start the map
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [-0.1276, 51.5072], // London
      zoom: 9
    });

    // OPTIONAL: once you have a tileset, add your properties layer here.
    map.on('load', () => {
      // Example placeholder: nothing to add yet.
      // Later you'll add a source 'props' and a layer 'properties-layer'
    });

    // 3) Subscribe to Ably channel filters:{session_id}
    const ably = new Ably.Realtime({ key: ABLY_CLIENT_KEY, clientId: sessionId });
    const channel = ably.channels.get(`filters:${sessionId}`);

    channel.subscribe('filter_update', (message) => {
      const payload = message.data || {};
      console.log('[Ably] filter_update', payload);

      // Move/zoom the map if viewport is provided
      if (payload.viewport?.bbox && Array.isArray(payload.viewport.bbox) && payload.viewport.bbox.length === 4) {
        const [minLon, minLat, maxLon, maxLat] = payload.viewport.bbox;
        map.fitBounds([[minLon, minLat], [maxLon, maxLat]], { padding: 48, duration: 800 });
      } else if (payload.viewport?.center) {
        map.flyTo({ center: payload.viewport.center, zoom: payload.viewport.zoom ?? 12, duration: 800 });
      }

      // Apply filters once your data layer exists
      // if (map.getLayer('properties-layer')) {
      //   const expr = buildMapboxExpression(payload.filters || {});
      //   map.setFilter('properties-layer', expr);
      // }
    });

    // Helper to build a Mapbox filter (uncomment when you add your layer)
    function buildMapboxExpression(f) {
      const clauses = [];
      if (f.price_lte != null) clauses.push(['<=', ['get','price_pcm'], f.price_lte]);
      if (f.beds_gte  != null) clauses.push(['>=', ['get','beds'], f.beds_gte]);
      if (Array.isArray(f.tags_any) && f.tags_any.length)
        clauses.push(['any', ...f.tags_any.map(tag => ['in', tag, ['get','tags']])]);
      if (f.uni) clauses.push(['==', ['get','nearest_uni'], f.uni]);
      return clauses.length ? ['all', ...clauses] : true;
    }
  </script>
</body>
</html>